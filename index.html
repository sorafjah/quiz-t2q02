<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç”»åƒä»˜ã2æŠã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª (Driveç›´ãƒªãƒ³ã‚¯è‡ªå‹•åŒ–ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    :focus-visible { outline: 2px solid #3b82f6; outline-offset: 2px; }
    .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-2xl mx-auto">
    <!-- ===== ãƒ›ãƒ¼ãƒ ç”»é¢ ===== -->
    <div id="home-screen" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
      <h1 class="text-3xl font-bold text-center text-gray-900">ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒä»˜ã2æŠã‚¯ã‚¤ã‚º</h1>
      <p class="text-center text-gray-500">ã‚¯ã‚¤ã‚ºã‚’ä½œæˆã™ã‚‹ã‹ã€ã‚¯ã‚¤ã‚ºåã‚’å…¥åŠ›ã—ã¦é–‹å§‹ãƒ»ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</p>

      <div>
        <button id="create-new-quiz-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-lg">æ–°ã—ã„ã‚¯ã‚¤ã‚ºã‚’ä½œæˆã™ã‚‹</button>
      </div>

      <div class="relative">
        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
        <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">ã¾ãŸã¯</span></div>
      </div>

      <div class="space-y-4">
        <label for="quiz-name-input-home" class="block text-sm font-medium text-gray-700">æ—¢å­˜ã®ã‚¯ã‚¤ã‚ºã‚’èª­ã¿è¾¼ã‚€</label>
        <input id="quiz-name-input-home" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ã‚¯ã‚¤ã‚ºåã‚’å…¥åŠ›"/>
        <div class="flex gap-4">
          <button id="edit-quiz-btn" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-lg">ã‚¯ã‚¤ã‚ºã‚’ç·¨é›†</button>
          <button id="start-quiz-btn" class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-lg">ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹</button>
        </div>
      </div>

      <!-- ä½¿ã„æ–¹ãƒ’ãƒ³ãƒˆ -->
      <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
        <p class="font-semibold">ğŸ“Œç”»åƒã®è²¼ã‚Šæ–¹ï¼ˆGoogleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€æ¨å¥¨ï¼‰</p>
        <ol class="list-decimal list-inside space-y-1 mt-1">
          <li>ãƒ‰ãƒ©ã‚¤ãƒ–ã§å…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ â†’ å…±æœ‰ã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ï¼šé–²è¦§è€…ã€ã«</li>
          <li>iPad/ã‚¹ãƒãƒ›ã‹ã‚‰ãã®ãƒ•ã‚©ãƒ«ãƒ€ã¸ç”»åƒã‚’ã‚¢ãƒƒãƒ—</li>
          <li>ç”»åƒã‚’é•·æŠ¼ã—â†’ã€Œãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã€ï¼ˆä¾‹ï¼š<span class="font-mono">drive.google.com/file/d/â€¦/view</span>ï¼‰</li>
          <li>ã“ã®ã‚¢ãƒ—ãƒªã«è²¼ã‚‹ã ã‘ã§è‡ªå‹•çš„ã« <span class="font-mono">uc?export=view&id=â€¦</span> ã«å¤‰æ›ã—ã¾ã™</li>
        </ol>
      </div>
    </div>

    <!-- ===== ç·¨é›†ç”»é¢ ===== -->
    <div id="edit-screen" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
      <h2 class="text-2xl font-bold text-gray-900">ã‚¯ã‚¤ã‚ºã®ä½œæˆãƒ»ç·¨é›†</h2>

      <div class="space-y-2">
        <label for="quiz-name-edit" class="block text-sm font-medium text-gray-700">ã‚¯ã‚¤ã‚ºå</label>
        <input id="quiz-name-edit" type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ä¾‹: å‹•ç‰©ã‚¯ã‚¤ã‚º"/>
      </div>

      <div class="space-y-2">
        <label for="json-input" class="block text-sm font-medium text-gray-700">
          JSONãƒ‡ãƒ¼ã‚¿ (ã“ã“ã‚’å…ƒã«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãŒç”Ÿæˆã•ã‚Œã¾ã™)
          <a href="https://chatgpt.com/g/g-68e79a810ad48191b8433cf72d5ea89b-2ze-json" target="_blank" rel="noopener noreferrer" class="ml-2 text-sm text-blue-600 underline hover:text-blue-800">(GPTsã§JSONã‚’ç”Ÿæˆ)</a>
        </label>
        <textarea id="json-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm" placeholder="ã“ã“ã«JSONã‚’è²¼ã‚Šä»˜ã‘ã¾ã™"></textarea>
      </div>

      <div id="edit-forms-container" class="space-y-6 border-t border-gray-200 pt-6">
        <p class="text-center text-gray-500">JSONã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€ã“ã“ã«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>

      <div class="border-t border-gray-200 pt-4">
        <button id="add-question-btn" type="button" class="w-full bg-green-100 hover:bg-green-200 text-green-800 font-bold py-3 px-4 rounded-lg transition duration-300">å•é¡Œã‚’è¿½åŠ ã™ã‚‹</button>
      </div>

      <div class="flex gap-4">
        <button id="back-to-home-btn" class="w-1/3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">æˆ»ã‚‹</button>
        <button id="save-quiz-btn" class="w-2/3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">ã“ã®å†…å®¹ã§ä¿å­˜</button>
      </div>
    </div>

    <!-- ===== å®Ÿè¡Œç”»é¢ ===== -->
    <div id="quiz-screen" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-4">
      <div id="question-img-container" class="hidden my-4">
        <img id="question-img" src="" class="w-full h-auto object-contain rounded-lg aspect-video mx-auto" alt="">
      </div>

      <div class="bg-gray-50 p-4 rounded-lg">
        <p id="question-text" class="text-xl font-semibold text-center min-h-[3em] flex items-center justify-center">å•é¡Œæ–‡ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>

      <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button id="option-a-btn" data-option="A" class="option-btn flex flex-col items-center justify-center p-2 border-4 border-transparent rounded-xl hover:border-blue-500 focus:border-blue-500 transition-all duration-300 space-y-2">
          <img id="option-a-img" src="" class="w-full h-auto object-contain rounded-lg aspect-[4/3] hidden" alt="">
          <p id="option-a-text" class="font-semibold text-center px-2">é¸æŠè‚¢A</p>
        </button>
        <button id="option-b-btn" data-option="B" class="option-btn flex flex-col items-center justify-center p-2 border-4 border-transparent rounded-xl hover:border-blue-500 focus:border-blue-500 transition-all duration-300 space-y-2">
          <img id="option-b-img" src="" class="w-full h-auto object-contain rounded-lg aspect-[4/3] hidden" alt="">
          <p id="option-b-text" class="font-semibold text-center px-2">é¸æŠè‚¢B</p>
        </button>
      </div>

      <div id="feedback-container" class="hidden p-4 rounded-lg space-y-4">
        <div class="text-center">
          <h3 id="feedback-result" class="text-2xl font-bold"></h3>
          <p id="feedback-explanation" class="text-gray-700 mt-1"></p>
        </div>
        <div class="flex justify-between items-center pt-2">
          <button id="quiz-back-to-home-btn" class="text-sm text-gray-500 hover:text-gray-700 transition duration-300 whitespace-nowrap">çµ‚äº†ã™ã‚‹</button>
          <button id="next-question-btn" class="text-lg font-bold text-green-600 hover:text-green-800 transition duration-300 whitespace-nowrap">æ¬¡ã¸</button>
        </div>
      </div>

      <div class="h-14"></div>
    </div>

    <!-- ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50"><div class="loader"></div></div>

    <!-- ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== -->
    <div id="message-box" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-3 px-5 rounded-lg shadow-xl">
      <p id="message-text"></p>
    </div>
  </div>

  <!-- ===== Firebase SDK ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- DOM ---
    const screens = { home: document.getElementById('home-screen'), edit: document.getElementById('edit-screen'), quiz: document.getElementById('quiz-screen') };
    const loadingIndicator = document.getElementById('loading-indicator');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');

    const createNewQuizBtn = document.getElementById('create-new-quiz-btn');
    const quizNameInputHome = document.getElementById('quiz-name-input-home');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const editQuizBtn = document.getElementById('edit-quiz-btn');
    const quizNameEdit = document.getElementById('quiz-name-edit');
    const jsonInput = document.getElementById('json-input');
    const editFormsContainer = document.getElementById('edit-forms-container');
    const addQuestionBtn = document.getElementById('add-question-btn');
    const saveQuizBtn = document.getElementById('save-quiz-btn');
    const backToHomeBtn = document.getElementById('back-to-home-btn');

    const questionText = document.getElementById('question-text');
    const questionImgContainer = document.getElementById('question-img-container');
    const questionImg = document.getElementById('question-img');
    const optionsContainer = document.getElementById('options-container');
    const optionABtn = document.getElementById('option-a-btn');
    const optionBBtn = document.getElementById('option-b-btn');
    const optionAImg = document.getElementById('option-a-img');
    const optionBImg = document.getElementById('option-b-img');
    const optionAText = document.getElementById('option-a-text');
    const optionBText = document.getElementById('option-b-text');
    const feedbackContainer = document.getElementById('feedback-container');
    const feedbackResult = document.getElementById('feedback-result');
    const feedbackExplanation = document.getElementById('feedback-explanation');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const quizBackToHomeBtn = document.getElementById('quiz-back-to-home-btn');

    // --- çŠ¶æ…‹ ---
    let db, auth, userId, currentQuizData = null, currentQuestionIndex = 0, score = 0;

    // â˜…è¿½åŠ ï¼šç¾åœ¨ç·¨é›†ä¸­ã®â€œãƒ­ãƒ¼ãƒ‰å…ƒã®åå‰â€ã‚’ä¿æŒ
    let loadedQuizName = null;

    // --- å…±é€šUI ---
    function showScreen(screenName){ Object.values(screens).forEach(s => s.classList.add('hidden')); screens[screenName]?.classList.remove('hidden'); }
    function showLoading(show){ loadingIndicator.classList.toggle('hidden', !show); }
    function showMessage(message, duration=3000, type='error'){
      messageBox.classList.remove('bg-red-500','bg-green-500');
      messageBox.classList.add(type==='success'?'bg-green-500':'bg-red-500');
      messageText.textContent = message;
      messageBox.classList.remove('hidden');
      setTimeout(()=>messageBox.classList.add('hidden'), duration);
    }

    // --- FirebaseåˆæœŸåŒ– ---
    async function initializeFirebase(){
      try{
        let rawConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? __firebase_config : {
          apiKey: "AIzaSyDwCD9JK4dahhbNW9ChLKDR6EmWecJbZuA",
          authDomain: "quiz-t2q.firebaseapp.com",
          projectId: "quiz-t2q",
          storageBucket: "quiz-t2q.appspot.com",
          messagingSenderId: "1035883523561",
          appId: "1:1035883523561:web:819c8e84be99bfc1ff2f78",
          measurementId: "G-J6JCMZN14J"
        };
        const firebaseConfig = (typeof rawConfig === 'string') ? JSON.parse(rawConfig) : rawConfig;
        if(!firebaseConfig.apiKey) throw new Error("Firebaseè¨­å®šã«apiKeyãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
          if(user){ userId = user.uid; }
          else{
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          }
        });
      }catch(err){
        console.error("FirebaseåˆæœŸåŒ–å¤±æ•—:", err);
        showMessage("Firebaseã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚", 5000);
        startQuizBtn.disabled = true; editQuizBtn.disabled = true;
        startQuizBtn.classList.add('opacity-50','cursor-not-allowed');
        editQuizBtn.classList.add('opacity-50','cursor-not-allowed');
      }
    }

    // === Driveç­‰ãƒªãƒ³ã‚¯æ­£è¦åŒ– ===
    function normalizeImageUrl(raw){
      if(!raw) return { url:"", ok:false, reason:"empty" };
      const url = raw.trim();

      // Google Photos (åŸ‹ã‚è¾¼ã‚ãªã„ç¨®)
      if(/^https?:\/\/photos\.google\.com\/photo\//.test(url)) return { url:"", ok:false, reason:"google_photos_page" };
      if(/^https?:\/\/photos\.app\.goo\.gl\//.test(url)) return { url:"", ok:false, reason:"google_photos_share_link" };

      // Google Drive 3ãƒ‘ã‚¿ãƒ¼ãƒ³
      let m = url.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//);
      if(m && m[1]) return { url:`https://drive.google.com/uc?export=view&id=${m[1]}`, ok:true };
      m = url.match(/https?:\/\/drive\.google\.com\/open\?id=([^&]+)/);
      if(m && m[1]) return { url:`https://drive.google.com/uc?export=view&id=${m[1]}`, ok:true };
      m = url.match(/https?:\/\/drive\.google\.com\/uc\?(?:[^#]*&)?id=([^&]+)/);
      if(m && m[1]) return { url:`https://drive.google.com/uc?export=view&id=${m[1]}`, ok:true };

      // Google Photos CDN (lh3) ã¯OKï¼ˆä»»æ„ã§=w1600ä»˜ä¸ï¼‰
      if(/^https?:\/\/lh3\.googleusercontent\.com\/[A-Za-z0-9_\-]/.test(url)){
        if(!/[?=]/.test(url)) return { url: url + "=w1600", ok:true };
        return { url, ok:true };
      }

      // fifeã¯ä¸å®‰å®šï¼ˆå‡ºã™ã‘ã©è­¦å‘Šï¼‰
      if(/^https?:\/\/photos\.fife\.usercontent\.google\.com\//.test(url)){
        const replaced = url.replace(/\/s\d+(-no)?/i, "/s1600-no");
        return { url: replaced, ok:true, warning:"fife_unstable" };
      }

      if(/^https?:\/\//.test(url)) return { url, ok:true };
      return { url:"", ok:false, reason:"invalid" };
    }

    // imgè¡¨ç¤ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
    function updatePreviewImage(rawUrl, imgElement){
      if(/\.(heic|heif)(\?.*)?$/i.test(rawUrl || "")){
        showMessage("ã“ã®ç”»åƒã¯HEICå½¢å¼ã§ã™ã€‚JPEG/PNGã«å¤‰æ›ã—ã¦ã‹ã‚‰ã”åˆ©ç”¨ãã ã•ã„ã€‚");
      }

      const { url, ok, reason, warning } = normalizeImageUrl(rawUrl || "");
      console.log("[image-url]", { rawUrl, normalized:url, ok, reason, warning });

      imgElement.onerror = null;

      if(!ok){
        imgElement.src = "";
        imgElement.classList.add("hidden");
        if(reason === "google_photos_page" || reason === "google_photos_share_link"){
          showMessage("Googleãƒ•ã‚©ãƒˆã®URLã¯åŸ‹ã‚è¾¼ã‚ã¾ã›ã‚“ã€‚Driveã®å…¬é–‹ãƒªãƒ³ã‚¯ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚");
        }else if(reason === "invalid"){
          showMessage("URLãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚https:// ã‹ã‚‰å§‹ã¾ã‚‹ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        return false;
      }

      imgElement.classList.remove("hidden");

      // å¤±æ•—æ™‚ã¯ Drive ã‚µãƒ ãƒã¸è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      let triedFallback = false;
      imgElement.onerror = () => {
        if(!triedFallback){
          triedFallback = true;
          const m = url.match(/\/uc\?export=view&id=([^&]+)/);
          if(m && m[1]){
            imgElement.src = `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1600`;
            return; // ã‚µãƒ ãƒã§å†è©¦è¡Œ
          }
        }
        imgElement.classList.add("hidden");
        showMessage("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¬é–‹è¨­å®šã‚„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼ˆJPEG/PNGï¼‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      };

      imgElement.src = url;

      if(warning === "fife_unstable"){
        showMessage("Googleãƒ•ã‚©ãƒˆã®ä¸€æ™‚ãƒªãƒ³ã‚¯ã§ã™ã€‚å°†æ¥è¡¨ç¤ºã§ããªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Driveå…¬é–‹ãƒ•ã‚©ãƒ«ãƒ€æ¨å¥¨ã€‚", 4000, "success");
      }
      return true;
    }

    // --- ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆ ---
    function setupEventListeners(){
      document.getElementById('create-new-quiz-btn').addEventListener('click', ()=>{
        loadedQuizName = null;            // â˜…æ–°è¦ã¯ãƒ­ãƒ¼ãƒ‰å…ƒãªã—
        resetEditScreen();
        showScreen('edit');
      });
      startQuizBtn.addEventListener('click', loadAndStartQuiz);
      editQuizBtn.addEventListener('click', loadQuizForEditing);
      saveQuizBtn.addEventListener('click', saveQuiz);
      backToHomeBtn.addEventListener('click', ()=>showScreen('home'));
      document.getElementById('quiz-back-to-home-btn').addEventListener('click', ()=>{ showScreen('home'); resetQuizState(); });
      jsonInput.addEventListener('input', handleJsonInputChange);
      addQuestionBtn.addEventListener('click', addQuestion);
      optionABtn.addEventListener('click', ()=>checkAnswer('A'));
      optionBBtn.addEventListener('click', ()=>checkAnswer('B'));
      nextQuestionBtn.addEventListener('click', displayNextQuestion);
    }

    function resetEditScreen(){
      quizNameEdit.value = '';
      jsonInput.value = '';
      editFormsContainer.innerHTML = '<p class="text-center text-gray-500">JSONã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€ã“ã“ã«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
    }

    function handleJsonInputChange(){
      const jsonText = jsonInput.value.trim();
      if(!jsonText){
        editFormsContainer.innerHTML = '<p class="text-center text-gray-500">JSONã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€ã“ã“ã«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
        return;
      }
      try{
        let data = JSON.parse(jsonText);
        if(Array.isArray(data)) data = { questions: data };
        if(data && Array.isArray(data.questions)) renderEditForms(data.questions);
        else editFormsContainer.innerHTML = '<p class="text-center text-red-500">JSONã«`questions`é…åˆ—ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
      }catch(e){
        editFormsContainer.innerHTML = '<p class="text-center text-yellow-600">æ­£ã—ã„JSONå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„...</p>';
      }
    }

    function renderEditForms(questions){
      editFormsContainer.innerHTML = '';
      questions.forEach((question, index) => {
        const qText = question.question || "";
        const qImgUrl = question.questionImageUrl || "";
        const textA = question.options?.A?.text || "";
        const imgUrlA = question.options?.A?.imageUrl || "";
        const textB = question.options?.B?.text || "";
        const imgUrlB = question.options?.B?.imageUrl || "";
        const answer = question.answer || "A";

        const formBlock = document.createElement('div');
        formBlock.className = 'space-y-4 p-4 border border-gray-200 rounded-lg bg-white question-form-block';
        formBlock.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="font-bold text-gray-800">å•é¡Œ ${index + 1}</h3>
            <div class="flex gap-2">
              <button type="button" class="move-up-btn text-sm text-gray-500 hover:text-blue-600 underline" data-index="${index}">â†‘ ä¸Šã¸</button>
              <button type="button" class="move-down-btn text-sm text-gray-500 hover:text-blue-600 underline" data-index="${index}">â†“ ä¸‹ã¸</button>
              <button type="button" class="delete-question-btn text-sm text-gray-500 hover:text-red-600 underline" data-index="${index}">å‰Šé™¤</button>
            </div>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700" for="question-text-edit-${index}">å•é¡Œæ–‡</label>
            <textarea id="question-text-edit-${index}" class="w-full p-2 border border-gray-300 rounded-lg" rows="2">${qText}</textarea>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700" for="image-url-q-${index}">å•é¡Œæ–‡ã®ç”»åƒURL (ä»»æ„)</label>
            <input type="url" id="image-url-q-${index}" data-index="${index}" data-type="Q" class="image-url-input w-full p-2 border border-gray-300 rounded-lg" placeholder="https://..." value="${qImgUrl}">
            <img id="preview-q-${index}" src="" class="mt-2 w-full h-auto object-contain rounded-lg aspect-video hidden" alt="">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div id="option-container-a-${index}" class="space-y-2 p-3 rounded-lg border ${answer==='A'?'bg-green-50 border-green-400':'bg-gray-50 border-gray-200'}">
              <div class="flex items-center gap-x-2">
                <input id="answer-a-${index}" name="answer-${index}" type="radio" value="A" class="answer-radio h-4 w-4" data-index="${index}" ${answer==='A'?'checked':''}>
                <label for="answer-a-${index}">é¸æŠè‚¢A (æ­£è§£ã«ã™ã‚‹)</label>
              </div>
              <label class="text-sm font-medium" for="option-text-a-${index}">ãƒ†ã‚­ã‚¹ãƒˆ</label>
              <textarea id="option-text-a-${index}" class="w-full p-2 border border-gray-300 rounded-lg" rows="2">${textA}</textarea>
              <label class="text-sm font-medium" for="image-url-a-${index}">ç”»åƒURL (ä»»æ„)</label>
              <input type="url" id="image-url-a-${index}" data-index="${index}" data-type="A" class="image-url-input w-full p-2 border border-gray-300 rounded-lg" placeholder="https://..." value="${imgUrlA}">
              <img id="preview-a-${index}" src="" class="mt-2 w-full h-auto object-contain rounded-lg aspect-[4/3] hidden" alt="">
            </div>
            <div id="option-container-b-${index}" class="space-y-2 p-3 rounded-lg border ${answer==='B'?'bg-green-50 border-green-400':'bg-gray-50 border-gray-200'}">
              <div class="flex items-center gap-x-2">
                <input id="answer-b-${index}" name="answer-${index}" type="radio" value="B" class="answer-radio h-4 w-4" data-index="${index}" ${answer==='B'?'checked':''}>
                <label for="answer-b-${index}">é¸æŠè‚¢B (æ­£è§£ã«ã™ã‚‹)</label>
              </div>
              <label class="text-sm font-medium" for="option-text-b-${index}">ãƒ†ã‚­ã‚¹ãƒˆ</label>
              <textarea id="option-text-b-${index}" class="w-full p-2 border border-gray-300 rounded-lg" rows="2">${textB}</textarea>
              <label class="text-sm font-medium" for="image-url-b-${index}">ç”»åƒURL (ä»»æ„)</label>
              <input type="url" id="image-url-b-${index}" data-index="${index}" data-type="B" class="image-url-input w-full p-2 border border-gray-300 rounded-lg" placeholder="https://..." value="${imgUrlB}">
              <img id="preview-b-${index}" src="" class="mt-2 w-full h-auto object-contain rounded-lg aspect-[4/3] hidden" alt="">
            </div>
          </div>
        `;
        editFormsContainer.appendChild(formBlock);

        // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        const qInput = document.getElementById(`image-url-q-${index}`);
        const aInput = document.getElementById(`image-url-a-${index}`);
        const bInput = document.getElementById(`image-url-b-${index}`);
        const qPrev  = document.getElementById(`preview-q-${index}`);
        const aPrev  = document.getElementById(`preview-a-${index}`);
        const bPrev  = document.getElementById(`preview-b-${index}`);
        if(qInput && qPrev) updatePreviewImage(qInput.value, qPrev);
        if(aInput && aPrev) updatePreviewImage(aInput.value, aPrev);
        if(bInput && bPrev) updatePreviewImage(bInput.value, bPrev);
      });

      setupEditFormEventListeners();
    }

    function setupEditFormEventListeners(){
      document.querySelectorAll('.image-url-input').forEach(input=>{
        input.addEventListener('input', (e)=>{
          const previewImg = document.getElementById(`preview-${e.target.dataset.type.toLowerCase()}-${e.target.dataset.index}`);
          updatePreviewImage(e.target.value, previewImg);
        });
      });

      document.querySelectorAll('.answer-radio').forEach(radio=>{
        radio.addEventListener('change', (e)=>{
          const index = e.target.dataset.index;
          const containerA = document.getElementById(`option-container-a-${index}`);
          const containerB = document.getElementById(`option-container-b-${index}`);
          if(e.target.value === 'A' && e.target.checked){
            containerA.classList.replace('bg-gray-50','bg-green-50'); containerA.classList.replace('border-gray-200','border-green-400');
            containerB.classList.replace('bg-green-50','bg-gray-50'); containerB.classList.replace('border-green-400','border-gray-200');
          }else{
            containerB.classList.replace('bg-gray-50','bg-green-50'); containerB.classList.replace('border-gray-200','border-green-400');
            containerA.classList.replace('bg-green-50','bg-gray-50'); containerA.classList.replace('border-green-400','border-gray-200');
          }
        });
      });

      document.querySelectorAll('.delete-question-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{ deleteQuestion(parseInt(e.target.dataset.index,10)); });
      });

      document.querySelectorAll('.move-up-btn').forEach(btn=>{
        btn.addEventListener('click', e=>moveQuestion(parseInt(e.target.dataset.index,10), -1));
      });
      document.querySelectorAll('.move-down-btn').forEach(btn=>{
        btn.addEventListener('click', e=>moveQuestion(parseInt(e.target.dataset.index,10), +1));
      });
    }

    function moveQuestion(index, direction){
      try{
        let data = JSON.parse(jsonInput.value.trim());
        if(Array.isArray(data)) data = { questions: data };
        const qs = buildQuestionsFromForm();
        const target = index + direction;
        if(target < 0 || target >= qs.length) return;
        const [moved] = qs.splice(index, 1);
        qs.splice(target, 0, moved);
        data.questions = qs;
        jsonInput.value = JSON.stringify(data, null, 2);
        handleJsonInputChange();
      }catch(e){
        showMessage("ä¸¦ã¹æ›¿ãˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error(e);
      }
    }

    function deleteQuestion(indexToDelete){
      try{
        let data;
        const jsonText = jsonInput.value.trim();
        if(jsonText){
          data = JSON.parse(jsonText);
          if(Array.isArray(data)) data = { questions: data };
        }else data = { questions: [] };

        if(!data.questions || !Array.isArray(data.questions)) return;

        const updated = buildQuestionsFromForm();
        data.questions = updated;
        data.questions.splice(indexToDelete, 1);
        jsonInput.value = JSON.stringify(data, null, 2);
        handleJsonInputChange();
      }catch(e){
        showMessage("JSONãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error("deleteQuestion:", e);
      }
    }

    function addQuestion(){
      try{
        let data;
        const jsonText = jsonInput.value.trim();
        if(jsonText){
          data = JSON.parse(jsonText);
          if(Array.isArray(data)) data = { questions: data };
        }else data = { questions: [] };
        if(!data.questions) data.questions = [];

        const existing = buildQuestionsFromForm();
        data.questions = existing;

        const newQuestion = {
          question: "æ–°ã—ã„å•é¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
          explanation: "ã“ã®å•é¡Œã®è§£èª¬ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
          answer: "A",
          options: {
            A: { text: "é¸æŠè‚¢ A", imageUrl: "" },
            B: { text: "é¸æŠè‚¢ B", imageUrl: "" }
          },
          questionImageUrl: ""
        };
        data.questions.push(newQuestion);
        jsonInput.value = JSON.stringify(data, null, 2);
        handleJsonInputChange();
        setTimeout(()=>editFormsContainer.lastChild?.scrollIntoView({behavior:'smooth'}), 100);
      }catch(e){
        showMessage("JSONãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        console.error("addQuestion:", e);
      }
    }

    function buildQuestionsFromForm(){
      const questions = [];
      const blocks = document.querySelectorAll('.question-form-block');
      blocks.forEach((_, i)=>{
        const questionTextVal = document.getElementById(`question-text-edit-${i}`)?.value ?? "";
        const optionATextVal = document.getElementById(`option-text-a-${i}`)?.value ?? "";
        const optionBTextVal = document.getElementById(`option-text-b-${i}`)?.value ?? "";
        const answerRadio = document.querySelector(`input[name="answer-${i}"]:checked`);

        let originalQuestion = {};
        try{
          const originalData = JSON.parse(jsonInput.value.trim());
          if(Array.isArray(originalData)) originalQuestion = { questions: originalData }.questions[i] || {};
          else originalQuestion = originalData.questions[i] || {};
        }catch(e){ /* no-op */ }

        questions.push({
          ...originalQuestion,
          question: questionTextVal,
          questionImageUrl: document.getElementById(`image-url-q-${i}`)?.value.trim() || "",
          options: {
            A: { text: optionATextVal, imageUrl: document.getElementById(`image-url-a-${i}`)?.value.trim() || "" },
            B: { text: optionBTextVal, imageUrl: document.getElementById(`image-url-b-${i}`)?.value.trim() || "" }
          },
          answer: answerRadio?.value || "A"
        });
      });
      return questions;
    }

    // â˜…å·®ã—æ›¿ãˆï¼šä¿å­˜ï¼ˆãƒ­ãƒ¼ãƒ‰å…ƒã¨åŒåâ†’ä¸Šæ›¸ãï¼åˆ¥åâ†’å…ƒã‚’æ®‹ã—ã¦æ–°è¦ï¼‰
    async function saveQuiz(){
      if(!db){ showMessage("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }

      const requestedName = quizNameEdit.value.trim();
      if(!requestedName){ showMessage("ã‚¯ã‚¤ã‚ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

      const newQuestions = buildQuestionsFromForm();
      if(newQuestions.length === 0){ showMessage("ä¿å­˜ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å•é¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"); return; }
      for(let i=0; i<newQuestions.length; i++){
        const q = newQuestions[i];
        if(!q.question || !q.options?.A?.text || !q.options?.B?.text){
          showMessage(`å•é¡Œ ${i+1} ã®å…¥åŠ›ãŒä¸å®Œå…¨ã§ã™ã€‚å•é¡Œæ–‡ã¨ä¸¡æ–¹ã®é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆã¯å¿…é ˆã§ã™ã€‚`);
          return;
        }
      }

      // ä¿å­˜å‰ã«ç”»åƒURLã‚’æ­£è¦åŒ–
      const norm = (u)=> normalizeImageUrl(u||"").url || "";
      newQuestions.forEach(q=>{
        q.questionImageUrl = norm(q.questionImageUrl);
        if(q.options?.A) q.options.A.imageUrl = norm(q.options.A.imageUrl);
        if(q.options?.B) q.options.B.imageUrl = norm(q.options.B.imageUrl);
      });

      const finalQuizData = {
        questions: newQuestions,
        updatedAt: new Date().toISOString()
      };

      showLoading(true);
      try{
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app-id';
        const basePath = `artifacts/${appId}/public/data/quizzes`;

        // åå‰æ¯”è¼ƒï¼šä¸€è‡´â†’ä¸Šæ›¸ãï¼ä¸ä¸€è‡´â†’åˆ¥åä¿å­˜ï¼ˆå…ƒã¯æ®‹ã™ï¼‰
        const isSaveAs = !loadedQuizName || requestedName !== loadedQuizName;
        const targetName = isSaveAs ? requestedName : loadedQuizName;

        const quizRef = doc(db, basePath, targetName);
        await setDoc(quizRef, finalQuizData);

        // è¡¨ç¤ºãƒ»çŠ¶æ…‹ã®æ›´æ–°
        quizNameEdit.value = targetName;
        loadedQuizName = targetName;

        showMessage(isSaveAs ? `åˆ¥åã§ä¿å­˜ã—ã¾ã—ãŸï¼š${targetName}` : "ä¿å­˜ã—ã¾ã—ãŸã€‚", 3000, 'success');
        jsonInput.value = JSON.stringify(finalQuizData, null, 2);
      }catch(error){
        console.error("Firestoreä¿å­˜å¤±æ•—:", error);
        showMessage("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }finally{
        showLoading(false);
      }
    }

    async function loadQuizForEditing(){
      if(!db){ showMessage("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      const quizName = quizNameInputHome.value.trim();
      if(!quizName){ showMessage("ã‚¯ã‚¤ã‚ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      showLoading(true);
      try{
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app-id';
        const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizName);
        const snap = await getDoc(quizRef);
        if(snap.exists()){
          const quizData = snap.data();
          resetEditScreen();
          quizNameEdit.value = quizName;
          loadedQuizName = quizName;                        // â˜…ãƒ­ãƒ¼ãƒ‰å…ƒåã‚’è¨˜éŒ²
          jsonInput.value = JSON.stringify(quizData, null, 2);
          showScreen('edit');
          jsonInput.dispatchEvent(new Event('input', { bubbles:true }));
        }else{
          showMessage("æŒ‡å®šã•ã‚ŒãŸã‚¯ã‚¤ã‚ºãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      }catch(e){
        console.error("èª­ã¿è¾¼ã¿å¤±æ•—:", e);
        showMessage("ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }finally{ showLoading(false); }
    }

    async function loadAndStartQuiz(){
      if(!db){ showMessage("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
      const quizName = quizNameInputHome.value.trim();
      if(!quizName){ showMessage("ã‚¯ã‚¤ã‚ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      showLoading(true);
      try{
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app-id';
        const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizName);
        const snap = await getDoc(quizRef);
        if(snap.exists()){
          currentQuizData = snap.data();
          if(!currentQuizData.questions || !Array.isArray(currentQuizData.questions) || currentQuizData.questions.length===0){
            showMessage("ã‚¯ã‚¤ã‚ºã«å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç·¨é›†ç”»é¢ã§å•é¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          resetQuizState();
          displayQuestion(0);
          showScreen('quiz');
        }else{
          showMessage("æŒ‡å®šã•ã‚ŒãŸã‚¯ã‚¤ã‚ºãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      }catch(e){
        console.error("èª­ã¿è¾¼ã¿å¤±æ•—:", e);
        showMessage("ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }finally{ showLoading(false); }
    }

    function resetQuizState(){
      currentQuestionIndex = 0; score = 0;
      feedbackContainer.classList.add('hidden');
      nextQuestionBtn.classList.add('hidden');
      optionABtn.disabled = false; optionBBtn.disabled = false;
      optionsContainer.classList.remove('hidden');
    }

    function nl2br(s){ return (s ?? "").toString().replace(/\n/g,"<br>"); }

    function displayQuestion(index){
      if(!currentQuizData?.questions) return;
      const question = currentQuizData.questions[index];
      if(!question) return;

      const hasQImg = !!(question.questionImageUrl && /^https?:\/\//.test(question.questionImageUrl));
      if(hasQImg){
        questionImgContainer.classList.remove('hidden');
        updatePreviewImage(question.questionImageUrl, questionImg);
      }else{
        questionImgContainer.classList.add('hidden');
        updatePreviewImage('', questionImg);
      }

      questionText.innerHTML = nl2br(question.question);

      optionAText.innerHTML = nl2br(question.options.A.text);
      if(updatePreviewImage(question.options.A.imageUrl, optionAImg)){
        optionABtn.classList.add('min-h-[10rem]'); optionABtn.classList.remove('py-6');
      }else{
        optionABtn.classList.remove('min-h-[10rem]'); optionABtn.classList.add('py-6');
      }

      optionBText.innerHTML = nl2br(question.options.B.text);
      if(updatePreviewImage(question.options.B.imageUrl, optionBImg)){
        optionBBtn.classList.add('min-h-[10rem]'); optionBBtn.classList.remove('py-6');
      }else{
        optionBBtn.classList.remove('min-h-[10rem]'); optionBBtn.classList.add('py-6');
      }

      feedbackContainer.classList.add('hidden');
      quizBackToHomeBtn.classList.add('hidden');
      nextQuestionBtn.classList.add('hidden');
      optionABtn.disabled = false; optionBBtn.disabled = false;
      optionABtn.classList.remove('border-green-500','border-red-500','border-gray-400');
      optionBBtn.classList.remove('border-green-500','border-red-500','border-gray-400');
    }

    function checkAnswer(selectedOption){
      optionABtn.disabled = true; optionBBtn.disabled = true;
      const question = currentQuizData.questions[currentQuestionIndex];
      const correct = question.answer;

      if(selectedOption === correct){
        feedbackResult.textContent = "æ­£è§£ï¼";
        feedbackResult.className = "text-2xl font-bold text-green-500";
        score++;
      }else{
        feedbackResult.textContent = "ã–ã‚“ã­ã‚“â€¦";
        feedbackResult.className = "text-2xl font-bold text-red-500";
      }

      feedbackExplanation.innerHTML = nl2br(question.explanation || "");
      feedbackContainer.classList.remove('hidden');
      nextQuestionBtn.classList.remove('hidden');
      quizBackToHomeBtn.classList.remove('hidden');
    }

    function displayNextQuestion(){
      currentQuestionIndex++;
      if(currentQuestionIndex < currentQuizData.questions.length) displayQuestion(currentQuestionIndex);
      else showFinalScore();
    }

    function showFinalScore(){
      questionText.textContent = `ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼ã‚ãªãŸã®ã‚¹ã‚³ã‚¢ã¯...`;
      optionsContainer.classList.add('hidden');
      questionImgContainer.classList.add('hidden');
      feedbackResult.textContent = `${currentQuizData.questions.length}å•ä¸­ ${score}å•æ­£è§£ï¼`;
      feedbackResult.className = "text-3xl font-bold text-blue-600";
      feedbackExplanation.textContent = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã€Œçµ‚äº†ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚";
      feedbackContainer.classList.remove('hidden');
      nextQuestionBtn.classList.add('hidden');
      quizBackToHomeBtn.classList.remove('hidden');
    }

    // --- åˆæœŸåŒ– ---
    window.onload = () => { initializeFirebase(); setupEventListeners(); showScreen('home'); };
  </script>
</body>
</html>
