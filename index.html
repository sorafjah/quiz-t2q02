<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像付き2択クイズアプリ (編集機能強化版)</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) を読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Interフォントを全体に適用 */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* タップ時のハイライトを無効化 */
        }
        /* ボタンや入力欄のフォーカス時のアウトラインを調整 */
        :focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <!-- ===== ホーム画面 ===== -->
        <div id="home-screen" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-900">テキストから画像付き2択クイズ</h1>
            <p class="text-center text-gray-500">クイズを作成するか、クイズ名を入力して開始・編集してください。</p>
            
            <div>
                <button id="create-new-quiz-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-lg">
                    新しいクイズを作成する
                </button>
            </div>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">または</span>
                </div>
            </div>

            <div class="space-y-4">
                <label for="quiz-name-input-home" class="block text-sm font-medium text-gray-700">既存のクイズを読み込む</label>
                <input type="text" id="quiz-name-input-home" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="クイズ名を入力">
                <div class="flex gap-4">
                    <button id="edit-quiz-btn" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-lg">
                        クイズを編集
                    </button>
                    <button id="start-quiz-btn" class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-lg">
                        クイズを開始
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== クイズ編集画面 ===== -->
        <div id="edit-screen" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
            <h2 class="text-2xl font-bold text-gray-900">クイズの作成・編集</h2>
            
            <div class="space-y-2">
                <label for="quiz-name-edit" class="block text-sm font-medium text-gray-700">クイズ名</label>
                <input type="text" id="quiz-name-edit" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="例: 動物クイズ">
            </div>

            <div class="space-y-2">
                    <label for="json-input" class="block text-sm font-medium text-gray-700">
                        JSONデータ (ここを元に編集フォームが生成されます)
                        <a href="https://chatgpt.com/g/g-68e79a810ad48191b8433cf72d5ea89b-2ze-json" target="_blank" rel="noopener noreferrer" class="ml-2 text-sm text-blue-600 underline hover:text-blue-800">
                            (GPTsでJSONを生成)
                        </a>
                    </label>
                <textarea id="json-input" rows="8" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm" placeholder="ここにGPTsで生成したJSONを貼り付けます"></textarea>
            </div>
            
            <!-- 問題編集フォームを動的に生成するコンテナ -->
            <div id="edit-forms-container" class="space-y-6 border-t border-gray-200 pt-6">
                <p class="text-center text-gray-500">JSONを貼り付けると、ここに編集フォームが表示されます。</p>
            </div>

            <!-- 問題追加ボタン -->
            <div class="border-t border-gray-200 pt-4">
                <button id="add-question-btn" type="button" class="w-full bg-green-100 hover:bg-green-200 text-green-800 font-bold py-3 px-4 rounded-lg transition duration-300">
                    問題を追加する
                </button>
            </div>

            <div class="flex gap-4">
                <button id="back-to-home-btn" class="w-1/3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                    戻る
                </button>
                <button id="save-quiz-btn" class="w-2/3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                    この内容で保存
                </button>
            </div>
        </div>

        <!-- ===== クイズ実行画面 ===== -->
        <div id="quiz-screen" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-4">
            
            <div id="question-img-container" class="hidden my-4">
                    <img id="question-img" src="" class="w-full h-auto object-contain rounded-lg aspect-video mx-auto">
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <p id="question-text" class="text-xl font-semibold text-center min-h-[3em] flex items-center justify-center">問題文がここに表示されます。</p>
            </div>

            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 選択肢A -->
                <button id="option-a-btn" data-option="A" class="option-btn flex flex-col items-center justify-center p-2 border-4 border-transparent rounded-xl hover:border-blue-500 focus:border-blue-500 transition-all duration-300 space-y-2">
                    <img id="option-a-img" src="" class="w-full h-auto object-contain rounded-lg aspect-[4/3] hidden">
                    <p id="option-a-text" class="font-semibold text-center px-2">選択肢A</p>
                </button>
                <!-- 選択肢B -->
                <button id="option-b-btn" data-option="B" class="option-btn flex flex-col items-center justify-center p-2 border-4 border-transparent rounded-xl hover:border-blue-500 focus:border-blue-500 transition-all duration-300 space-y-2">
                    <img id="option-b-img" src="" class="w-full h-auto object-contain rounded-lg aspect-[4/3] hidden">
                    <p id="option-b-text" class="font-semibold text-center px-2">選択肢B</p>
                </button>
            </div>
            
            <div id="feedback-container" class="hidden p-4 rounded-lg space-y-4">
                <div class="text-center">
                    <h3 id="feedback-result" class="text-2xl font-bold"></h3>
                    <p id="feedback-explanation" class="text-gray-700 mt-1"></p>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <button id="quiz-back-to-home-btn" class="text-sm text-gray-500 hover:text-gray-700 transition duration-300 whitespace-nowrap">
                        終了する
                    </button>
                    <button id="next-question-btn" class="text-lg font-bold text-green-600 hover:text-green-800 transition duration-300 whitespace-nowrap">
                        次へ
                    </button>
                </div>
            </div>
            
            <!--レイアウト用の空のコンテナ-->
            <div class="h-14"></div>

        </div>
        
        <!-- ===== ローディング表示 ===== -->
        <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="loader"></div>
        </div>

        <!-- ===== メッセージボックス ===== -->
        <div id="message-box" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-3 px-5 rounded-lg shadow-xl animate-pulse">
            <p id="message-text"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM要素の取得 ---
        const screens = { home: document.getElementById('home-screen'), edit: document.getElementById('edit-screen'), quiz: document.getElementById('quiz-screen'), };
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const createNewQuizBtn = document.getElementById('create-new-quiz-btn');
        const quizNameInputHome = document.getElementById('quiz-name-input-home');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const editQuizBtn = document.getElementById('edit-quiz-btn'); 
        const quizNameEdit = document.getElementById('quiz-name-edit');
        const jsonInput = document.getElementById('json-input');
        const editFormsContainer = document.getElementById('edit-forms-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const saveQuizBtn = document.getElementById('save-quiz-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const questionText = document.getElementById('question-text');
        const questionImgContainer = document.getElementById('question-img-container');
        const questionImg = document.getElementById('question-img');
        const optionsContainer = document.getElementById('options-container');
        const optionABtn = document.getElementById('option-a-btn');
        const optionBBtn = document.getElementById('option-b-btn');
        const optionAImg = document.getElementById('option-a-img');
        const optionBImg = document.getElementById('option-b-img');
        const optionAText = document.getElementById('option-a-text');
        const optionBText = document.getElementById('option-b-text');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackResult = document.getElementById('feedback-result');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const quizBackToHomeBtn = document.getElementById('quiz-back-to-home-btn');

        // --- グローバル変数 ---
        let db, auth, userId, currentQuizData = null, currentQuestionIndex = 0, score = 0;
        
        // --- Firebase初期化 ---
        async function initializeFirebase() {
            try {
                let rawConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    rawConfig = __firebase_config;
                } else {
                    console.warn("Firebaseの環境設定`__firebase_config`が見つかりません。フォールバック用の接続情報を使用します。");
                    rawConfig = {
                        apiKey: "AIzaSyDwCD9JK4dahhbNW9ChLKDR6EmWecJbZuA",
                        authDomain: "quiz-t2q.firebaseapp.com",
                        projectId: "quiz-t2q",
                        storageBucket: "quiz-t2q.appspot.com",
                        messagingSenderId: "1035883523561",
                        appId: "1:1035883523561:web:819c8e84be99bfc1ff2f78",
                        measurementId: "G-J6JCMZN14J"
                    };
                }

                const firebaseConfig = (typeof rawConfig === 'string')
                    ? JSON.parse(rawConfig)
                    : rawConfig;

                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase設定にapiKeyが含まれていません。");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) { 
                console.error("Firebaseの初期化に失敗しました:", error); 
                showMessage("Firebaseへの接続に失敗しました。設定が正しくない可能性があります。", 5000); 
                startQuizBtn.disabled = true;
                editQuizBtn.disabled = true;
                startQuizBtn.classList.add('opacity-50', 'cursor-not-allowed');
                editQuizBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- 画面制御 ---
        function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.add('hidden')); screens[screenName]?.classList.remove('hidden'); }
        function showLoading(show) { loadingIndicator.classList.toggle('hidden', !show); }
        function showMessage(message, duration = 3000, type = 'error') {
            messageBox.classList.remove('bg-red-500', 'bg-green-500');
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), duration);
        }

        // --- イベントリスナー設定 ---
        function setupEventListeners() {
            createNewQuizBtn.addEventListener('click', () => { resetEditScreen(); showScreen('edit'); });
            startQuizBtn.addEventListener('click', loadAndStartQuiz);
            editQuizBtn.addEventListener('click', loadQuizForEditing);
            saveQuizBtn.addEventListener('click', saveQuiz);
            backToHomeBtn.addEventListener('click', () => showScreen('home'));
            quizBackToHomeBtn.addEventListener('click', () => { showScreen('home'); resetQuizState(); });
            jsonInput.addEventListener('input', handleJsonInputChange);
            addQuestionBtn.addEventListener('click', addQuestion);
            optionABtn.addEventListener('click', () => checkAnswer('A'));
            optionBBtn.addEventListener('click', () => checkAnswer('B'));
            nextQuestionBtn.addEventListener('click', displayNextQuestion);
        }

        function resetEditScreen() {
            quizNameEdit.value = '';
            jsonInput.value = '';
            editFormsContainer.innerHTML = '<p class="text-center text-gray-500">JSONを貼り付けると、ここに編集フォームが表示されます。</p>';
        }

        function handleJsonInputChange() {
            const jsonText = jsonInput.value.trim();
            if (!jsonText) { editFormsContainer.innerHTML = '<p class="text-center text-gray-500">JSONを貼り付けると、ここに編集フォームが表示されます。</p>'; return; }
            try {
                let data = JSON.parse(jsonText);
                if (Array.isArray(data)) { data = { questions: data }; }
                if (data && Array.isArray(data.questions)) { renderEditForms(data.questions); } 
                else { editFormsContainer.innerHTML = '<p class="text-center text-red-500">JSONに`questions`配列が含まれていません。</p>'; }
            } catch (e) { editFormsContainer.innerHTML = '<p class="text-center text-yellow-600">正しいJSON形式で入力してください...</p>'; }
        }

        function renderEditForms(questions) {
            editFormsContainer.innerHTML = ''; 
            questions.forEach((question, index) => {
                const qText = question.question || '';
                const qImgUrl = question.questionImageUrl || '';
                const textA = question.options?.A?.text || '';
                const imgUrlA = question.options?.A?.imageUrl || '';
                const textB = question.options?.B?.text || '';
                const imgUrlB = question.options?.B?.imageUrl || '';
                const answer = question.answer || 'A';

                const formBlock = document.createElement('div');
                formBlock.className = 'space-y-4 p-4 border border-gray-200 rounded-lg bg-white question-form-block';
                formBlock.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">問題 ${index + 1}</h3>
                        <button type="button" class="delete-question-btn text-sm text-gray-500 hover:text-red-600 underline" data-index="${index}">この問題を削除</button>
                    </div>
                    <div class="space-y-2">
                        <label for="question-text-edit-${index}" class="block text-sm font-medium text-gray-700">問題文</label>
                        <textarea id="question-text-edit-${index}" class="w-full p-2 border border-gray-300 rounded-lg" rows="2">${qText}</textarea>
                    </div>
                    <div class="space-y-2">
                        <label for="image-url-q-${index}" class="block text-sm font-medium text-gray-700">問題文の画像URL (任意)</label>
                        <input type="url" id="image-url-q-${index}" data-index="${index}" data-type="Q" class="image-url-input w-full p-2 border border-gray-300 rounded-lg" placeholder="https://..." value="${qImgUrl}">
                        <img id="preview-q-${index}" src="${qImgUrl}" class="mt-2 w-full h-auto object-contain rounded-lg aspect-video ${qImgUrl ? '' : 'hidden'}">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="option-container-a-${index}" class="space-y-2 p-3 rounded-lg border ${answer === 'A' ? 'bg-green-50 border-green-400' : 'bg-gray-50 border-gray-200'}">
                            <div class="flex items-center gap-x-2"><input id="answer-a-${index}" name="answer-${index}" type="radio" value="A" class="answer-radio h-4 w-4" data-index="${index}" ${answer === 'A' ? 'checked' : ''}><label for="answer-a-${index}">選択肢A (正解にする)</label></div>
                            <label for="option-text-a-${index}" class="text-sm font-medium">テキスト</label><input type="text" id="option-text-a-${index}" class="w-full p-2 border border-gray-300 rounded-lg" value="${textA}">
                            <label for="image-url-a-${index}" class="text-sm font-medium">画像URL (任意)</label><input type="url" id="image-url-a-${index}" data-index="${index}" data-type="A" class="image-url-input w-full p-2 border border-gray-300 rounded-lg" placeholder="https://..." value="${imgUrlA}">
                            <img id="preview-a-${index}" src="${imgUrlA}" class="mt-2 w-full h-auto object-contain rounded-lg aspect-[4/3] ${imgUrlA ? '' : 'hidden'}">
                        </div>
                        <div id="option-container-b-${index}" class="space-y-2 p-3 rounded-lg border ${answer === 'B' ? 'bg-green-50 border-green-400' : 'bg-gray-50 border-gray-200'}">
                           <div class="flex items-center gap-x-2"><input id="answer-b-${index}" name="answer-${index}" type="radio" value="B" class="answer-radio h-4 w-4" data-index="${index}" ${answer === 'B' ? 'checked' : ''}><label for="answer-b-${index}">選択肢B (正解にする)</label></div>
                           <label for="option-text-b-${index}" class="text-sm font-medium">テキスト</label><input type="text" id="option-text-b-${index}" class="w-full p-2 border border-gray-300 rounded-lg" value="${textB}">
                           <label for="image-url-b-${index}" class="text-sm font-medium">画像URL (任意)</label><input type="url" id="image-url-b-${index}" data-index="${index}" data-type="B" class="image-url-input w-full p-2 border border-gray-300 rounded-lg" placeholder="https://..." value="${imgUrlB}">
                           <img id="preview-b-${index}" src="${imgUrlB}" class="mt-2 w-full h-auto object-contain rounded-lg aspect-[4/3] ${imgUrlB ? '' : 'hidden'}">
                        </div>
                    </div>
                `;
                editFormsContainer.appendChild(formBlock);
            });
            setupEditFormEventListeners();
        }

        function setupEditFormEventListeners() {
             document.querySelectorAll('.image-url-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const previewImg = document.getElementById(`preview-${e.target.dataset.type.toLowerCase()}-${e.target.dataset.index}`);
                    updatePreviewImage(e.target.value, previewImg);
                });
            });
             document.querySelectorAll('.answer-radio').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const containerA = document.getElementById(`option-container-a-${index}`);
                    const containerB = document.getElementById(`option-container-b-${index}`);
                    if (e.target.value === 'A' && e.target.checked) {
                        containerA.classList.replace('bg-gray-50', 'bg-green-50'); containerA.classList.replace('border-gray-200', 'border-green-400');
                        containerB.classList.replace('bg-green-50', 'bg-gray-50'); containerB.classList.replace('border-green-400', 'border-gray-200');
                    } else {
                        containerB.classList.replace('bg-gray-50', 'bg-green-50'); containerB.classList.replace('border-gray-200', 'border-green-400');
                        containerA.classList.replace('bg-green-50', 'bg-gray-50'); containerA.classList.replace('border-green-400', 'border-gray-200');
                    }
                });
            });
            document.querySelectorAll('.delete-question-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    deleteQuestion(index);
                });
            });
        }
        
        function updatePreviewImage(url, imgElement) {
            const isValidUrl = !!(url && /^https?:\/\//.test(url));
            imgElement.src = isValidUrl ? url : '';
            imgElement.classList.toggle('hidden', !isValidUrl);
            return isValidUrl;
        }

        function deleteQuestion(indexToDelete) {
            try {
                let data;
                const jsonText = jsonInput.value.trim();
                if (jsonText) {
                    data = JSON.parse(jsonText);
                    if (Array.isArray(data)) data = { questions: data };
                } else {
                    data = { questions: [] };
                }

                if (!data.questions || !Array.isArray(data.questions)) return;

                const updatedQuestions = buildQuestionsFromForm();
                data.questions = updatedQuestions;
                
                data.questions.splice(indexToDelete, 1);
                jsonInput.value = JSON.stringify(data, null, 2);
                handleJsonInputChange(); 
            } catch (e) {
                showMessage("JSONデータの処理中にエラーが発生しました。");
                console.error("Error while deleting question:", e);
            }
        }

        function addQuestion() {
            try {
                let data;
                const jsonText = jsonInput.value.trim();
                
                if (jsonText) {
                    data = JSON.parse(jsonText);
                    if (Array.isArray(data)) data = { questions: data };
                } else {
                    data = { questions: [] };
                }
                if (!data.questions) data.questions = [];

                const existingQuestions = buildQuestionsFromForm();
                data.questions = existingQuestions;

                const newQuestion = {
                    question: "新しい問題のテキストを入力してください",
                    explanation: "この問題の解説を入力してください。",
                    answer: "A",
                    options: {
                        A: { text: "選択肢 A", imageUrl: "" },
                        B: { text: "選択肢 B", imageUrl: "" }
                    },
                    questionImageUrl: ""
                };
                data.questions.push(newQuestion);
                jsonInput.value = JSON.stringify(data, null, 2);
                handleJsonInputChange(); 
                
                setTimeout(() => {
                     editFormsContainer.lastChild?.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            } catch (e) {
                showMessage("JSONデータの処理中にエラーが発生しました。");
                console.error("Error while adding question:", e);
            }
        }
        
        function buildQuestionsFromForm() {
            const questions = [];
            const formBlocks = document.querySelectorAll('.question-form-block');
            formBlocks.forEach((_, i) => {
                const questionText = document.getElementById(`question-text-edit-${i}`)?.value.trim() || "";
                const optionAText = document.getElementById(`option-text-a-${i}`)?.value.trim() || "";
                const optionBText = document.getElementById(`option-text-b-${i}`)?.value.trim() || "";
                const answerRadio = document.querySelector(`input[name="answer-${i}"]:checked`);
                
                let originalQuestion = {};
                try {
                    const originalData = JSON.parse(jsonInput.value.trim());
                    if (Array.isArray(originalData)) {
                         originalQuestion = { questions: originalData }.questions[i] || {};
                    } else {
                         originalQuestion = originalData.questions[i] || {};
                    }
                } catch(e) { /* ignore */ }

                questions.push({
                    ...originalQuestion,
                    question: questionText,
                    questionImageUrl: document.getElementById(`image-url-q-${i}`)?.value.trim() || "",
                    options: {
                        A: { text: optionAText, imageUrl: document.getElementById(`image-url-a-${i}`)?.value.trim() || "" },
                        B: { text: optionBText, imageUrl: document.getElementById(`image-url-b-${i}`)?.value.trim() || "" }
                    },
                    answer: answerRadio?.value || "A"
                });
            });
            return questions;
        }

        async function saveQuiz() {
            if (!db) { showMessage("データベースに接続されていません。"); return; }
            const quizName = quizNameEdit.value.trim();
            if (!quizName) { showMessage("クイズ名を入力してください。"); return; }

            const newQuestions = buildQuestionsFromForm();
            
            if (newQuestions.length === 0) {
                showMessage("保存する問題がありません。問題を追加してください。");
                return;
            }

            for (let i = 0; i < newQuestions.length; i++) {
                const q = newQuestions[i];
                if (!q.question || !q.options.A.text || !q.options.B.text) {
                    showMessage(`問題 ${i + 1} の入力が不完全です。問題文と両方の選択肢テキストは必須です。`); 
                    return;
                }
            }

            const finalQuizData = { questions: newQuestions };
            showLoading(true);
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizName);
                await setDoc(quizRef, finalQuizData);
                showMessage("クイズが正常に保存されました！", 3000, 'success');
                jsonInput.value = JSON.stringify(finalQuizData, null, 2);
                setTimeout(() => showScreen('home'), 1000);
            } catch (error) {
                console.error("Firebaseへの保存に失敗しました:", error); showMessage("保存に失敗しました。");
            } finally { showLoading(false); }
        }

        async function loadQuizForEditing() {
            if (!db) { showMessage("データベースに接続されていません。"); return; }
            const quizName = quizNameInputHome.value.trim();
            if (!quizName) { showMessage("クイズ名を入力してください。"); return; }
            showLoading(true);
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizName);
                const docSnap = await getDoc(quizRef);
                if (docSnap.exists()) {
                    const quizData = docSnap.data();
                    resetEditScreen();
                    quizNameEdit.value = quizName;
                    jsonInput.value = JSON.stringify(quizData, null, 2);
                    showScreen('edit');
                    jsonInput.dispatchEvent(new Event('input', { bubbles: true })); 
                } else { showMessage("指定されたクイズが見つかりませんでした。"); }
            } catch (error) { console.error("Firebaseからの読み込みに失敗しました:", error); showMessage("クイズの読み込みに失敗しました。");
            } finally { showLoading(false); }
        }
        
        async function loadAndStartQuiz() {
            if (!db) { showMessage("データベースに接続されていません。"); return; }
            const quizName = quizNameInputHome.value.trim();
            if (!quizName) { showMessage("クイズ名を入力してください。"); return; }
            showLoading(true);
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizName);
                const docSnap = await getDoc(quizRef);
                if (docSnap.exists()) {
                    currentQuizData = docSnap.data();
                    if (!currentQuizData.questions || !Array.isArray(currentQuizData.questions) || currentQuizData.questions.length === 0) { 
                        showMessage("クイズに問題がありません。編集画面で問題を追加してください。"); return; 
                    }
                    resetQuizState();
                    displayQuestion(0);
                    showScreen('quiz');
                } else { showMessage("指定されたクイズが見つかりませんでした。"); }
            } catch (error) { console.error("Firebaseからの読み込みに失敗しました:", error); showMessage("クイズの読み込みに失敗しました。");
            } finally { showLoading(false); }
        }
        
        function resetQuizState() { 
            currentQuestionIndex = 0; 
            score = 0; 
            feedbackContainer.classList.add('hidden'); 
            nextQuestionBtn.classList.add('hidden'); 
            optionABtn.disabled = false; 
            optionBBtn.disabled = false; 
            optionsContainer.classList.remove('hidden'); 
        }
        
        function displayQuestion(index) {
            if (!currentQuizData || !currentQuizData.questions) return;
            const question = currentQuizData.questions[index];
            if (!question) return;

            // 質問画像の表示制御（コンテナも一緒に）
            const hasQImg = !!(question.questionImageUrl && /^https?:\/\//.test(question.questionImageUrl));
            if (hasQImg) {
                questionImgContainer.classList.remove('hidden');
                updatePreviewImage(question.questionImageUrl, questionImg);
            } else {
                questionImgContainer.classList.add('hidden');
                updatePreviewImage('', questionImg);
            }

            questionText.textContent = question.question;

            // 選択肢A/B
            optionAText.textContent = question.options.A.text;
            if (updatePreviewImage(question.options.A.imageUrl, optionAImg)) {
                optionABtn.classList.add('min-h-[10rem]');
                optionABtn.classList.remove('py-6');
            } else {
                optionABtn.classList.remove('min-h-[10rem]');
                optionABtn.classList.add('py-6');
            }

            optionBText.textContent = question.options.B.text;
            if (updatePreviewImage(question.options.B.imageUrl, optionBImg)) {
                optionBBtn.classList.add('min-h-[10rem]');
                optionBBtn.classList.remove('py-6');
            } else {
                optionBBtn.classList.remove('min-h-[10rem]');
                optionBBtn.classList.add('py-6');
            }

            // 状態リセット
            feedbackContainer.classList.add('hidden');
            quizBackToHomeBtn.classList.add('hidden'); // 「終了する」ボタンを隠す
            nextQuestionBtn.classList.add('hidden');
            optionABtn.disabled = false;
            optionBBtn.disabled = false;
            optionABtn.classList.remove('border-green-500', 'border-red-500', 'border-gray-400');
            optionBBtn.classList.remove('border-green-500', 'border-red-500', 'border-gray-400');
        }
        
        function checkAnswer(selectedOption) {
            optionABtn.disabled = true;
            optionBBtn.disabled = true;
            const question = currentQuizData.questions[currentQuestionIndex];
            const correctOption = question.answer;
            const selectedBtn = selectedOption === 'A' ? optionABtn : optionBBtn;
            const correctBtn = correctOption === 'A' ? optionABtn : optionBBtn;
            if (selectedOption === correctOption) {
                feedbackResult.textContent = "正解！";
                feedbackResult.className = "text-2xl font-bold text-green-500";
                selectedBtn.classList.add('border-green-500');
                score++;
            } else {
                feedbackResult.textContent = "ざんねん…";
                feedbackResult.className = "text-2xl font-bold text-red-500";
                selectedBtn.classList.add('border-gray-400');
                correctBtn.classList.add('border-green-500');
            }
            feedbackExplanation.textContent = question.explanation;
            feedbackContainer.classList.remove('hidden');
            nextQuestionBtn.classList.remove('hidden');
            quizBackToHomeBtn.classList.remove('hidden'); // 「終了する」ボタンを表示
        }
        
        function displayNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizData.questions.length) { displayQuestion(currentQuestionIndex); } 
            else { showFinalScore(); }
        }
        
        function showFinalScore() {
            questionText.textContent = `クイズ終了！あなたのスコアは...`;
            optionsContainer.classList.add('hidden');
            questionImgContainer.classList.add('hidden');

            feedbackResult.textContent = `${currentQuizData.questions.length}問中 ${score}問正解！`;
            feedbackResult.className = "text-3xl font-bold text-blue-600";
            feedbackExplanation.textContent = "お疲れ様でした。「終了する」ボタンでホームに戻ります。";
            
            feedbackContainer.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden'); // 「次へ」は隠す
            quizBackToHomeBtn.classList.remove('hidden'); // 「終了する」は表示
        }

        // --- 初期化処理 ---
        window.onload = () => { initializeFirebase(); setupEventListeners(); showScreen('home'); };

    </script>
</body>
</html>



